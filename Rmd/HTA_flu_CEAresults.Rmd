---
title: "HTA flu (uncertainty)"
toc: FALSE
---

<div style="text-align: right">
[Home page](index.html)
</div>

```{r libs, cache=FALSE, echo=FALSE, results = "hide", warning = FALSE}
set.seed(2020)

knitr::opts_chunk$set(fig.cap='', fig.align="center", message=FALSE, warning=FALSE, fig.height = 6, fig.width = 10)
```

This model was developed by Philippe Beutels, Joke Bilcke and Lander Willem for illustration and teaching purposes only. 
Please make contact if you would like to use this model in any public way.

In the field of economic evaluation in general, it could be applicable to any intervention with effectiveness realised 
within one year (like many curative interventions). In the field of infectious disease, it would only be applicable to 
influenza, and only if vaccination targets a small proportion of the population that does not at the same time form a 
core transmitter group of the virus (eg it is unlikely to be suitable to model childhood influenza vaccination). Note 
that for most applications, practical use of this model would likely entail having separate, though similarly simple 
decision trees to obtain the unit cost estimates (implying that these cells would be intermediary 
outcomes, and that there would be additional input cells for each relevant stage of disease (for instance for the number
of consultations, the unit costs per consultation, medication use, hospital days etc for cases of pneumonia, and all 
other relevant disease stages)).

Note that the final output is independent of coverage and target group size, if fixed administration costs are set to 0. 
This is due to the exclusion of herd immunity effects in this model.  

For further information, questions or comments please contact us.

# Set working directory
The first step when creating a new R file is to specify a working directory. You need to tell the R session where you want it to work. To do this you use the command to "set the working directory" or `setwd()`. 

You can label this working directory as 'home', and have other locations stored for plotting or for getting data. This location should be an existing folder on your computer. For example

```{r results = "hide", eval = FALSE}
home <- "~/Documents/Modelling_intro/"     # on OS X
home <- "C:\\Documents\\Modelling_intro\\" # on windows
setwd(home)
```

# Package(s)

If BCEA package is not installed yet, you can do so by
```{r results = "hide", eval=FALSE}
if(!"BCEA" %in% installed.packages()){
        install.packages('BCEA')
}
```

Once installed, you have to load the package(s) at the start of the R file. This is done using 

```{r results = "hide"}
library(BCEA)
```

# Goal and input

The goal is to calculate the cost-effectiveness of a vaccination program for the elderly against flu, taking into account parameter uncertainty as specified below:

```{r results = "hide"}

# set number of samples to include in the uncertainty analysis
Nsamples<-5000

# set the random-number-generator seed to get exactly the same results each time you run the code
set.seed(698) 

# population details
targetgroup     <- 2500000 								#people>65 years
life_expectancy <- rnorm(Nsamples,mean=12,sd=2) 				#in years
discount_rate   <- 0.015

# disease burden
force_of_infection      <- rbeta(Nsamples,4,96) 	#draw Nsamples randomly from a beta distribution with parameters 4 and 96
proportion_hospitalised <- rbeta(Nsamples,10,90)
casefatality_ratio      <- rbeta(Nsamples,30,970)

# disease-related costs
cost_per_hospitalised_case    <- rnorm(Nsamples,2000,100)  #dollars
cost_per_nonhospitalised_case <- rnorm(Nsamples,100,5) 	   #dollars

# program details
uptake_program                <- 0.80
vaccine_efficacy              <- rnorm(Nsamples,mean=0.6,sd=(0.7-0.5)/(2*1.96))
vaccine_price_per_dose        <- 10 			   #dollars
admin_cost_per_dose           <- rnorm(Nsamples,50,4) 	   #dollars
fixed_program_costs           <- 0 			   #dollars

# QALY
QALYslost_per_hospitalised_case    <- rnorm(Nsamples,mean=0.018,sd=0.0018)
alpha_qaly_nonhosp                 <- (0.0082^2*(1-0.0082)/0.0018^2)-0.0082
QALYslost_per_nonhospitalised_case <- rbeta(Nsamples,alpha_qaly_nonhosp,alpha_qaly_nonhosp*(1-0.0082)/0.0082)

```

# Health Technology Assessment: step-by-step

Now, propagate the uncertainty from the input parameters of the flu model into the outcome of your flu model. To start the health technology assessment, we calculate the vaccine cost per dose and the treatment cost per case, taking into account the proportion of cases that lead to hospitalization, the QALY lost per case, and the discounted life expectancy:
```{r }
vaccine_cost_per_dose     <- vaccine_price_per_dose + admin_cost_per_dose
treatment_cost_per_case   <- cost_per_hospitalised_case * proportion_hospitalised + 
                              (1-proportion_hospitalised) * cost_per_nonhospitalised_case
QALYslost_per_case        <- QALYslost_per_hospitalised_case * proportion_hospitalised +        
                               QALYslost_per_nonhospitalised_case * (1-proportion_hospitalised)

life_expectancy_disc <- rep(NA,Nsamples)
for (i in 1:Nsamples){
        life_expectancy_disc[i] <- sum(1/((1+discount_rate)^(1:life_expectancy[i])))
}

```


Calculate the burden of disease with the program in place, along with the associated medical and program costs:
```{r eval = FALSE}
### Similar to the previous tutorial: "HTA Flu (basic)"
```

```{r include = FALSE}
# Program
population_at_risk         <- targetgroup * (1-uptake_program) + targetgroup * uptake_program * (1-vaccine_efficacy)

program_infections         <- population_at_risk * force_of_infection 
program_hospitalisations   <- program_infections * proportion_hospitalised
program_deaths             <- program_infections * casefatality_ratio
program_lifeyearslost      <- program_deaths * life_expectancy
program_lifeyearslost_disc <- program_deaths * life_expectancy

program_treatmentcosts     <- program_infections * treatment_cost_per_case
program_vaccinationcosts   <- fixed_program_costs + targetgroup * uptake_program * vaccine_cost_per_dose
program_totaldirectcosts   <- program_treatmentcosts + program_vaccinationcosts

program_QALYslost          <- program_infections * QALYslost_per_case + program_lifeyearslost
program_QALYslost_disc     <- program_infections * QALYslost_per_case + program_lifeyearslost_disc

```

Calculate the burden of disease for the comparator without the program in place, including the medical costs:
```{r eval = FALSE}
### Similar to the previous tutorial: "HTA Flu (basic)"
```

```{r include = FALSE}
# Comparator
comparator_infections         <- targetgroup * force_of_infection
comparator_hospitalisations   <- comparator_infections * proportion_hospitalised
comparator_deaths             <- comparator_infections * casefatality_ratio
comparator_lifeyearslost      <- comparator_deaths * life_expectancy
comparator_lifeyearslost_disc <- comparator_deaths * life_expectancy_disc
        
comparator_treatmentcosts     <- comparator_infections * treatment_cost_per_case
comparator_vaccinationcosts   <- 0
comparator_totaldirectcosts   <- comparator_treatmentcosts + comparator_vaccinationcosts

comparator_QALYslost       <- comparator_infections * QALYslost_per_case + comparator_lifeyearslost
comparator_QALYslost_disc  <- comparator_infections * QALYslost_per_case + comparator_lifeyearslost_disc

```

Calculate the difference between the program and the comparator:
```{r eval = FALSE}
### Similar to the previous tutorial: "HTA Flu (basic)"
```

```{r include = FALSE}
# To calculate the difference between 'program' and 'comparator' 
infections_averted          <- comparator_infections - program_infections
hospitalisations_averted    <- comparator_hospitalisations - program_hospitalisations
deaths_averted              <- comparator_deaths - program_deaths
lifeyearslost_averted       <- comparator_lifeyearslost - program_lifeyearslost
lifeyearslost_averted_disc  <- comparator_lifeyearslost_disc - program_lifeyearslost_disc

QALY_gained                 <- comparator_QALYslost - program_QALYslost
QALY_gained_disc            <- comparator_QALYslost_disc - program_QALYslost_disc

treatment_costs_averted     <- comparator_treatmentcosts - program_treatmentcosts
incr_vaccination_costs      <- program_vaccinationcosts - comparator_vaccinationcosts # incremental costs
incr_total_costs            <- incr_vaccination_costs - treatment_costs_averted

```

Calculate the incremental effectiveness ratios for infections, hospitalizations, and deaths averted. Finally, calculate the incremental effectiveness ratios for life years saved:
```{r eval = FALSE}
### Similar to the previous tutorial: "HTA Flu (basic)"
```

```{r include = FALSE}

# Calculate incremental effectiveness ratios
incr_cost_per_case_prevented            <- incr_total_costs / infections_averted
incr_cost_per_hospitalisation_prevented <- incr_total_costs / hospitalisations_averted
incr_cost_per_death_averted             <- incr_total_costs / deaths_averted
incr_cost_per_lifeyear_gained           <- incr_total_costs / lifeyearslost_averted
incr_cost_per_lifeyear_gained_disc      <- incr_total_costs / lifeyearslost_averted_disc
incr_costs_per_QALY_gained              <- incr_total_costs / QALY_gained
incr_costs_per_QALY_gained_disc         <- incr_total_costs / QALY_gained_disc

```

Show the results:
```{r }
# combine results
# note: specify column names at once
ICER_values<-cbind(incr_cost_per_case_prevented        = incr_cost_per_case_prevented,
               incr_cost_per_hospitalisation_prevented = incr_cost_per_hospitalisation_prevented,
               incr_cost_per_death_averted             = incr_cost_per_death_averted,
               incr_cost_per_lifeyear_gained           = incr_cost_per_lifeyear_gained,
               incr_cost_per_lifeyear_gained_disc      = incr_cost_per_lifeyear_gained_disc,
               incr_costs_per_QALY_gained              = incr_costs_per_QALY_gained,
               incr_costs_per_QALY_gained_disc         = incr_costs_per_QALY_gained_disc)

head(round(ICER_values)) # print
```
Please note that there may be slight variations due to platform and R-version specific differences in random number generation.

```{r include = FALSE, eval=FALSE}

variable_vaccinationcost_perdose<-vaccineprice_perdose+administrationcosts_perdose
treatment_costs_per_case<-cost_per_hospitalised_case*proportion_hospitalised+(1-proportion_hospitalised)*cost_per_nonhospitalised_case
QALYslost_per_case<-QALYslost_per_hospitalised_case*proportion_hospitalised+(1-proportion_hospitalised)*QALYslost_per_nonhospitalised_case
discounted_life_expectancy<-rep(NA,Nsamples)
for (i in 1:Nsamples)
{discounted_life_expectancy[i]<-sum(1/((1+discountrate)^(1:life_expectancy[i])))}

#Program
program_infections<-targetgroup*uptake_program*force_of_infection*(1-vaccine_efficacy)+targetgroup*(1-uptake_program)*force_of_infection
program_hospitalisations<-program_infections*proportion_hospitalised
program_deaths<-program_infections*casefatality_ratio
program_lifeyearslost<-program_deaths*discounted_life_expectancy
program_QALYslost<-program_infections*QALYslost_per_case+program_lifeyearslost

program_treatmentcosts<-program_infections*treatment_costs_per_case
program_vaccinationcosts<-ifelse(uptake_program!=0,targetgroup*uptake_program*variable_vaccinationcost_perdose+fixed_program_costs,targetgroup*uptake_program*varaible_vaccinationcost_perdose)
program_totaldirectcosts<-program_treatmentcosts+program_vaccinationcosts

#No Program
noprogram_infections<-targetgroup*force_of_infection
noprogram_hospitalisations<-noprogram_infections*proportion_hospitalised
noprogram_deaths<-noprogram_infections*casefatality_ratio
noprogram_lifeyearslost<-noprogram_deaths*discounted_life_expectancy
noprogram_QALYslost<-noprogram_infections*QALYslost_per_case+noprogram_lifeyearslost

noprogram_treatmentcosts<-noprogram_infections*treatment_costs_per_case
noprogram_vaccinationcosts<-0
noprogram_totaldirectcosts<-noprogram_treatmentcosts+noprogram_vaccinationcosts

#Difference between 'program' and 'no program' (events and costs averted)
diff_infections1.5<-noprogram_infections-program_infections
diff_hospitalisations1.5<-noprogram_hospitalisations-program_hospitalisations
diff_deaths1.5<-noprogram_deaths-program_deaths
diff_lifeyearslost1.5<-noprogram_lifeyearslost-program_lifeyearslost
diff_QALYslost1.5<-noprogram_QALYslost-program_QALYslost

diff_treatmentcosts1.5<-noprogram_treatmentcosts-program_treatmentcosts
diff_vaccinationcosts1.5<-noprogram_vaccinationcosts-program_vaccinationcosts
diff_totaldirectcosts1.5<--(diff_treatmentcosts1.5+diff_vaccinationcosts1.5)

```

# Cost-effectiveness analysis condidering uncertainty (using BCEA package).

1. Run the `bcea()`function to obtain the cost-effectiveness plane, the expected incremental net monetary benefit (INMB), the cost-effectiveness acceptability curve (CEAC) and the expected value for perfect information (EVPI):
```{r }
# inspect the documenation of the 'bcea()' function
?bcea

# Specify a matrix containing the clinical effectiveness for each intervention being considered.
# note: this needs to be specified as health gain (i.e. negative health loss)
ce_effects <- cbind(-comparator_QALYslost_disc,-program_QALYslost_disc)


# Specify a matrix containing the cost for each intervention being considered.
# note: this needs to be specified as health gain (i.e. negative health loss)
ce_costs   <- cbind(comparator_totaldirectcosts,program_totaldirectcosts)

# Define the labels to be associated with each intervention.
interventions = c("No intervention","Vaccine program")

# Run the 'bcea()' function
m <- bcea(eff = ce_effects,
          cost = ce_costs,
          ref = 2,  # the column of eff and costconsidered to be the reference strategy.
          interventions = interventions,
          plot = T) #ref specifies to compare 'Vaccine program' to 'No intervention'

```

2. Which decision should we take, given current information and for a range of WTP values? Print the summary of the `bcea()` function:
```{r }
summary(m)
```

To be sure, calculate the ICER manually:
```{r }
ICER <- mean(incr_total_costs) / mean(QALY_gained_disc)
ICER
```

To be sure, calculate the INMB manually:
```{r }
wtp_k <- 25000
INMB  <- mean((QALY_gained_disc*wtp_k)-incr_total_costs)
INMB
```

3. How much evidence is there in favor of the decision, for a range of WTP values? Look also at the CEAC above.
```{r }
m_ceaf <- multi.ce(m)
ceaf.plot(m_ceaf) # uses base plot 
abline(h=0.5)
```    

4. Is there value in further research? Look at the EVPI graph and summary above.
```{r }

```
       


```{r include = FALSE, eval = FALSE}
#Generate output
### 1. Cost-effectiveness plane --> see plots
### 
        #--> see plots cost-effectiveness plane and expected incremental benefit
        #--> see summary: 'optimal decision' and 'Vaccination vs Standard care'
        summary(m)
        #--> or calculate manually:
        mean(incr_total_costs)/mean(QALY_gained_disc) #average ICER
        k=25000
        mean((QALY_gained_disc*k)-incr_total_costs)#average INMB for k
        #--> average INMB of vaccination compared to standard care, for the range of WTP values considered
        m$eib 
### 3. How much evidence is there in favor of the decision, for a range of WTP values 
        #--> see plot cost-effectiveness acceptability curve
        #--> see summary 'Vaccination vs Standard care: CEAC'
        summary(m)
        #--> construct a cost-effectiveness acceptability frontier plot
        m_ceaf<-multi.ce(m)
        ceaf.plot(m_ceaf,graph='ggplot2') #but no color used?
        #data needed to construct CEAC and CEAF plots
        m_ceafceac=cbind(m$k,ints[m$best],m$ceac) 
        colnames(m_ceafceac)=c('wtp value','optimal decision','probability highest INMB ref')
        
### 4. Is there value in further research? 
        #--> see Expected Value of Information plot
        #--> see summary 'EVPI'
        summary(m)
        #data needed to construct EVPI plot:
        m_evpi=cbind(m$k,m$evi)
        colnames(m_evpi)=c('wtp value','evpi')

```

<br>
<br>

<div>
# Navigate
Top: [Index](index.html)
</div>

